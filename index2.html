<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Family Habit Tracker</title>
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{
      font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Oxygen,Ubuntu,sans-serif;
      background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);
      min-height:100vh;padding:20px;transition:background .5s ease}
    .container{max-width:1200px;margin:0 auto;animation:slideIn .5s ease-out}
    @keyframes slideIn{from{opacity:0;transform:translateY(-20px)}to{opacity:1;transform:translateY(0)}}
    .header{text-align:center;color:#fff;margin-bottom:30px;position:relative}
    .header h1{font-size:2.5em;margin-bottom:10px;text-shadow:2px 2px 4px rgba(0,0,0,.2);animation:glow 2s ease-in-out infinite alternate}
    @keyframes glow{from{text-shadow:2px 2px 4px rgba(0,0,0,.2),0 0 10px rgba(255,255,255,.2)}to{text-shadow:2px 2px 4px rgba(0,0,0,.2),0 0 20px rgba(255,255,255,.4)}}
    .user-info{background:rgba(255,255,255,.2);padding:10px 20px;border-radius:20px;display:inline-block;margin-bottom:15px;backdrop-filter:blur(10px)}
    .user-mode{display:inline-flex;gap:10px;align-items:center}
    .mode-switch{padding:8px 16px;background:rgba(255,255,255,.3);border:none;border-radius:10px;color:#fff;cursor:pointer;transition:all .3s ease;font-weight:600}
    .mode-switch:hover{background:rgba(255,255,255,.4);transform:scale(1.05)}
    .mode-switch.active{background:rgba(255,255,255,.5)}
    .week-info{font-size:1.1em;opacity:.95;margin-bottom:10px}
    .stats{display:flex;justify-content:center;gap:30px;margin-top:15px;flex-wrap:wrap}
    .stat{background:rgba(255,255,255,.2);padding:10px 20px;border-radius:20px;backdrop-filter:blur(10px);transition:transform .3s ease,background .3s ease}
    .stat:hover{transform:translateY(-2px);background:rgba(255,255,255,.3)}
    .main-card{background:rgba(255,255,255,.95);border-radius:20px;padding:30px;box-shadow:0 20px 40px rgba(0,0,0,.1);backdrop-filter:blur(10px);margin-bottom:20px}
    .input-section{display:flex;gap:10px;margin-bottom:30px}
    .input-section.parent-mode{opacity:.5;pointer-events:none}
    .task-input{flex:1;padding:15px;border:2px solid #e0e0e0;border-radius:12px;font-size:16px;transition:all .3s ease;background:#fff}
    .task-input:focus{outline:none;border-color:#667eea;box-shadow:0 0 0 3px rgba(102,126,234,.1);transform:scale(1.02)}
    .add-btn{padding:15px 30px;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:#fff;border:none;border-radius:12px;font-size:16px;font-weight:600;cursor:pointer;transition:all .3s ease;position:relative;overflow:hidden}
    .add-btn::before{content:'';position:absolute;top:0;left:-100%;width:100%;height:100%;background:linear-gradient(90deg,transparent,rgba(255,255,255,.3),transparent);transition:left .5s ease}
    .add-btn:hover::before{left:100%}
    .add-btn:hover{transform:translateY(-2px);box-shadow:0 10px 20px rgba(102,126,234,.3)}
    .habits-grid{max-height:600px;overflow-y:auto;padding-right:10px}
    .habits-grid::-webkit-scrollbar{width:8px}
    .habits-grid::-webkit-scrollbar-track{background:#f1f1f1;border-radius:10px}
    .habits-grid::-webkit-scrollbar-thumb{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);border-radius:10px}
    .habit-item{background:#f8f9fa;border-radius:16px;padding:20px;margin-bottom:20px;animation:taskSlideIn .3s ease-out;box-shadow:0 2px 10px rgba(0,0,0,.05);transition:all .3s ease;position:relative;overflow:hidden}
    @keyframes taskSlideIn{from{opacity:0;transform:translateX(-20px)}to{opacity:1;transform:translateX(0)}}
    .habit-item::before{content:'';position:absolute;left:0;top:0;height:100%;width:4px;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%)}
    .habit-item:hover{transform:translateY(-2px);box-shadow:0 10px 30px rgba(0,0,0,.1)}
    .habit-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:15px}
    .habit-name{font-size:18px;font-weight:600;color:#333;display:flex;align-items:center;gap:10px}
    .streak-badge{background:linear-gradient(135deg,#f093fb 0%,#f5576c 100%);color:#fff;padding:4px 10px;border-radius:20px;font-size:12px;font-weight:600;animation:pulse 2s infinite}
    @keyframes pulse{0%,100%{transform:scale(1)}50%{transform:scale(1.05)}}
    .delete-habit-btn{padding:8px 12px;background:#ff6b6b;color:#fff;border:none;border-radius:8px;cursor:pointer;transition:all .3s ease;font-size:14px;opacity:.8}
    .delete-habit-btn.parent-mode{opacity:.5;pointer-events:none}
    .delete-habit-btn:hover{opacity:1;transform:scale(1.05);box-shadow:0 5px 10px rgba(255,107,107,.3)}
    .days-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:10px}
    .day-box{background:#fff;border:2px solid #e0e0e0;border-radius:12px;padding:15px 10px;text-align:center;cursor:pointer;transition:all .3s ease;position:relative;overflow:hidden}
    .day-box.parent-mode{cursor:default}
    .day-box:hover:not(.parent-mode){transform:translateY(-3px);box-shadow:0 5px 15px rgba(0,0,0,.1)}
    .day-box.completed{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);border-color:transparent;color:#fff;animation:checkIn .5s ease}
    @keyframes checkIn{0%{transform:scale(.8) rotate(-10deg)}50%{transform:scale(1.1) rotate(5deg)}100%{transform:scale(1) rotate(0)}}
    .day-box.completed::after{content:'‚úì';position:absolute;top:5px;right:5px;font-size:20px;animation:checkPop .3s ease}
    @keyframes checkPop{0%{transform:scale(0)}50%{transform:scale(1.2)}100%{transform:scale(1)}}
    .day-name{font-weight:600;font-size:14px;margin-bottom:5px}
    .day-date{font-size:12px;opacity:.7}
    .habit-progress{margin-top:15px;padding-top:15px;border-top:1px solid #e0e0e0}
    .progress-info{display:flex;justify-content:space-between;margin-bottom:8px;font-size:14px;color:#666}
    .progress-bar{height:8px;background:#e0e0e0;border-radius:10px;overflow:hidden;position:relative}
    .progress-fill{height:100%;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);border-radius:10px;transition:width .5s ease;position:relative;overflow:hidden}
    .progress-fill::after{content:'';position:absolute;top:0;left:0;right:0;bottom:0;background:linear-gradient(90deg,transparent,rgba(255,255,255,.3),transparent);animation:shimmer 2s infinite}
    @keyframes shimmer{0%{transform:translateX(-100%)}100%{transform:translateX(100%)}}
    .empty-state{text-align:center;padding:80px 20px;color:#999}
    .empty-state-icon{font-size:64px;margin-bottom:20px;opacity:.5}
    .setup-section{background:#fff3cd;border:2px solid #ffc107;border-radius:12px;padding:20px;margin-bottom:20px;color:#856404}
    .week-navigation{display:flex;justify-content:center;align-items:center;gap:20px;margin-bottom:20px}
    .nav-btn{padding:8px 16px;background:rgba(255,255,255,.2);color:#fff;border:none;border-radius:8px;cursor:pointer;transition:all .3s ease;font-size:16px}
    .nav-btn:hover{background:rgba(255,255,255,.3);transform:scale(1.05)}
    .nav-btn:disabled{opacity:.5;cursor:not-allowed}
    .connection-status{position:fixed;bottom:20px;right:20px;padding:10px 20px;background:#4caf50;color:#fff;border-radius:20px;display:flex;align-items:center;gap:10px;font-size:14px;box-shadow:0 4px 12px rgba(0,0,0,.15);z-index:1000}
    .connection-status.offline{background:#ff9800}
    .connection-status.error{background:#f44336}
    .status-dot{width:8px;height:8px;background:#fff;border-radius:50%;animation:pulse 2s infinite}
    .clear-all-btn{margin-top:20px;padding:12px 24px;background:linear-gradient(135deg,#ff6b6b 0%,#ff5252 100%);color:#fff;border:none;border-radius:12px;cursor:pointer;transition:all .3s ease;font-size:14px;font-weight:600;display:block;margin-left:auto;margin-right:auto}
    .clear-all-btn.parent-mode{opacity:.5;pointer-events:none}
    .clear-all-btn:hover{transform:translateY(-2px);box-shadow:0 10px 20px rgba(255,107,107,.3)}
    /* missing animation referenced in JS */
    @keyframes shake{0%,100%{transform:translateX(0)}20%,60%{transform:translateX(-6px)}40%,80%{transform:translateX(6px)}}
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>üë®‚Äçüë©‚Äçüëß Family Habit Tracker</h1>
      <div class="user-info">
        <div class="user-mode">
          <span>Mode:</span>
          <button class="mode-switch active" id="kidMode" onclick="setMode('kid')">üëß Kid</button>
          <button class="mode-switch" id="parentMode" onclick="setMode('parent')">üë®‚Äçüë©‚Äçüëß Parent View</button>
        </div>
      </div>
      <div class="week-navigation">
        <button class="nav-btn" onclick="changeWeek(-1)" id="prevWeekBtn">‚Üê Previous</button>
        <div class="week-info" id="weekInfo"></div>
        <button class="nav-btn" onclick="changeWeek(1)" id="nextWeekBtn">Next ‚Üí</button>
      </div>
      <div class="stats">
        <div class="stat"><span id="totalHabits">0</span> Habits</div>
        <div class="stat"><span id="weeklyCompletions">0</span> Completions</div>
        <div class="stat"><span id="overallRate">0</span>% Success Rate</div>
      </div>
    </div>

    <div class="main-card">
      <div class="input-section" id="inputSection">
        <input type="text" class="task-input" id="habitInput" placeholder="What habit do you want to track this week?"/>
        <button class="add-btn" onclick="addHabit()">Add Habit</button>
      </div>
      <div class="habits-grid" id="habitsGrid"></div>
      <button class="clear-all-btn" onclick="clearAllHabits()" style="display:none" id="clearBtn">Clear All Habits</button>
    </div>
  </div>

  <div class="connection-status" id="connectionStatus">
    <div class="status-dot"></div>
    <span id="statusText">Local Storage Only</span>
  </div>

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>

  <script>
    // ========= FIREBASE CONFIG =========
    const firebaseConfig = {
      apiKey: "AIzaSyDDkdy2Dz0s7LHSWKgBLpevPFn0FDwt9os",
      authDomain: "habit-tracker-pk.firebaseapp.com",
      projectId: "habit-tracker-pk",
      storageBucket: "habit-tracker-pk.appspot.com", // <- appspot.com is typical; adjust if needed
      messagingSenderId: "790945841915",
      appId: "1:790945841915:web:d9d21446d294a86d46a65e",
      measurementId: "G-8JTCS6ZKW2"
    };

    // ========= APP STATE =========
    let habits = [];
    let currentWeekOffset = 0;
    let currentWeekDates = [];
    let currentMode = 'kid'; // 'kid' | 'parent'
    let db = null;
    let unsubscribe = null;
    let isFirebaseConfigured = false;

    // ========= INIT FIREBASE (if configured) =========
    try {
      if (firebaseConfig && firebaseConfig.apiKey) {
        firebase.initializeApp(firebaseConfig);
        db = firebase.firestore();
        isFirebaseConfigured = true;
        updateConnectionStatus('online', 'Connected to Cloud');
        startRealtimeSync();
      }
    } catch (e) {
      console.error('Firebase init error:', e);
      updateConnectionStatus('error', 'Configuration Error');
      isFirebaseConfigured = false;
    }

    // ========= DOM READY =========
    document.addEventListener('DOMContentLoaded', () => {
      if (!isFirebaseConfigured) loadHabitsLocal();
      updateWeekInfo();
      renderHabits();

      document.getElementById('habitInput').addEventListener('keypress', (e) => {
        if (e.key === 'Enter' && currentMode === 'kid') addHabit();
      });
    });

    window.addEventListener('beforeunload', () => {
      if (unsubscribe) unsubscribe();
    });

    // ========= UI HELPERS =========
    function setMode(mode) {
      currentMode = mode;
      document.getElementById('kidMode').classList.toggle('active', mode === 'kid');
      document.getElementById('parentMode').classList.toggle('active', mode === 'parent');

      const inputSection = document.getElementById('inputSection');
      const clearBtn = document.getElementById('clearBtn');
      if (mode === 'parent') {
        inputSection.classList.add('parent-mode');
        if (clearBtn) clearBtn.classList.add('parent-mode');
      } else {
        inputSection.classList.remove('parent-mode');
        if (clearBtn) clearBtn.classList.remove('parent-mode');
      }
      renderHabits();
    }

    function updateConnectionStatus(status, text) {
      const el = document.getElementById('connectionStatus');
      const txt = document.getElementById('statusText');
      el.classList.remove('offline', 'error');
      if (status === 'offline') el.classList.add('offline');
      if (status === 'error') el.classList.add('error');
      txt.textContent = text || '';
    }

    function startRealtimeSync() {
      if (!db) return;
      if (unsubscribe) unsubscribe();

      unsubscribe = db.collection('habits').onSnapshot(
        (snapshot) => {
          habits = [];
          snapshot.forEach((doc) => {
            habits.push({ id: doc.id, ...doc.data() });
          });
          // newest first
          habits.sort((a, b) => {
            const dateA = a.createdAt ? new Date(a.createdAt) : new Date(0);
            const dateB = b.createdAt ? new Date(b.createdAt) : new Date(0);
            return dateB - dateA;
          });
          renderHabits();
          updateConnectionStatus('online', 'Synced with Cloud');
        },
        (error) => {
          console.error('Sync error:', error);
          updateConnectionStatus('error', 'Sync Error');
          loadHabitsLocal();
        }
      );
    }

    // ========= DATES/WEEKS =========
    function getWeekDates(offset = 0) {
      const dates = [];
      const now = new Date();
      now.setDate(now.getDate() + offset * 7);

      const weekStart = new Date(now);
      weekStart.setDate(now.getDate() - now.getDay()); // Sunday start

      for (let i = 0; i < 7; i++) {
        const d = new Date(weekStart);
        d.setDate(weekStart.getDate() + i);
        dates.push(d);
      }
      return dates;
    }

    function updateWeekInfo() {
      currentWeekDates = getWeekDates(currentWeekOffset);
      const weekStart = currentWeekDates[0];
      const weekEnd = currentWeekDates[6];

      const months = ['January','February','March','April','May','June','July','August','September','October','November','December'];
      const label = `${months[weekStart.getMonth()]} ${weekStart.getDate()} - ${months[weekEnd.getMonth()]} ${weekEnd.getDate()}, ${weekEnd.getFullYear()}`;
      document.getElementById('weekInfo').textContent = label;

      // can't go to future weeks beyond current
      document.getElementById('nextWeekBtn').disabled = currentWeekOffset >= 0;
    }

    function changeWeek(direction) {
      currentWeekOffset += direction;
      updateWeekInfo();
      renderHabits();
    }

    function getDateKey(date) {
      return `${date.getFullYear()}-${String(date.getMonth()+1).padStart(2,'0')}-${String(date.getDate()).padStart(2,'0')}`;
    }

    // ========= CRUD =========
    async function addHabit() {
      if (currentMode === 'parent') return;
      const input = document.getElementById('habitInput');
      const habitText = input.value.trim();
      if (!habitText) {
        input.style.animation = 'shake .5s';
        setTimeout(() => (input.style.animation = ''), 500);
        return;
      }

      const habit = { name: habitText, completions: {}, createdAt: new Date().toISOString() };

      if (db) {
        try {
          await db.collection('habits').add(habit);
          updateConnectionStatus('online', 'Synced with Cloud');
        } catch (err) {
          console.error('Add habit error:', err);
          updateConnectionStatus('error', 'Sync Error - Saved Locally');
          habit.id = Date.now();
          habits.unshift(habit);
          saveHabitsLocal();
          renderHabits();
        }
      } else {
        habit.id = Date.now();
        habits.unshift(habit);
        saveHabitsLocal();
        renderHabits();
      }

      input.value = '';
      input.focus();
    }

    async function toggleDay(habitId, dateKey) {
      if (currentMode === 'parent') return;

      // prevent future dates
      const [y,m,d] = dateKey.split('-').map(Number);
      const date = new Date(y, m-1, d);
      const today = new Date();
      today.setHours(0,0,0,0);
      date.setHours(0,0,0,0);
      if (date > today) return;

      if (db) {
        try {
          const ref = db.collection('habits').doc(habitId);
          const snap = await ref.get();
          if (snap.exists) {
            const completions = snap.data().completions || {};
            if (completions[dateKey]) delete completions[dateKey];
            else completions[dateKey] = true;
            await ref.update({ completions });
            updateConnectionStatus('online', 'Synced with Cloud');
          }
        } catch (err) {
          console.error('Toggle error:', err);
          updateConnectionStatus('error', 'Sync Error');
        }
      } else {
        const habit = habits.find(h => h.id === habitId || h.id == habitId);
        if (!habit) return;
        habit.completions ||= {};
        if (habit.completions[dateKey]) delete habit.completions[dateKey];
        else habit.completions[dateKey] = true;
        saveHabitsLocal();
        renderHabits();
      }
    }

    async function deleteHabit(id) {
      if (currentMode === 'parent') return;
      if (!confirm('Delete this habit?')) return;

      if (db) {
        try {
          await db.collection('habits').doc(id).delete();
          updateConnectionStatus('online', 'Synced with Cloud');
        } catch (err) {
          console.error('Delete error:', err);
          updateConnectionStatus('error', 'Sync Error');
        }
      } else {
        habits = habits.filter(h => h.id !== id && h.id != id);
        saveHabitsLocal();
        renderHabits();
      }
    }

    async function clearAllHabits() {
      if (currentMode === 'parent') return;
      if (!confirm('Clear ALL habits and tracking?')) return;

      if (db) {
        try {
          const batch = db.batch();
          const snap = await db.collection('habits').get();
          snap.docs.forEach(doc => batch.delete(doc.ref));
          await batch.commit();
          updateConnectionStatus('online', 'Synced with Cloud');
        } catch (err) {
          console.error('Clear error:', err);
          updateConnectionStatus('error', 'Sync Error');
        }
      } else {
        habits = [];
        saveHabitsLocal();
        renderHabits();
      }
    }

    // ========= METRICS =========
    function calculateStreak(habit) {
      const keys = Object.keys(habit.completions || {}).sort().reverse();
      if (keys.length === 0) return 0;

      let streak = 0;
      const today = new Date(); today.setHours(0,0,0,0);

      // Start from today and go backwards day-by-day until a miss
      for (let i = 0; ; i++) {
        const d = new Date(today); d.setDate(today.getDate() - i);
        const key = getDateKey(d);
        if (habit.completions && habit.completions[key]) streak++;
        else break;
      }
      return streak;
    }

    function getWeeklyCompletions() {
      const weekKeys = currentWeekDates.map(getDateKey);
      let total = 0;
      habits.forEach(h => {
        const comp = h.completions || {};
        weekKeys.forEach(k => { if (comp[k]) total++; });
      });
      return total;
    }

    function getOverallRate() {
      let done = 0, possible = 0;
      habits.forEach(h => {
        const comp = h.completions || {};
        done += Object.keys(comp).length;
        // approximate possible as #days since created (clamped to today)
        if (h.createdAt) {
          const start = new Date(h.createdAt); start.setHours(0,0,0,0);
          const today = new Date(); today.setHours(0,0,0,0);
          const days = Math.max(1, Math.floor((today - start) / (1000*60*60*24)) + 1);
          possible += days;
        }
      });
      if (possible === 0) return 0;
      return Math.round((done / possible) * 100);
    }

    // ========= STORAGE FALLBACK =========
    const LS_KEY = 'family_habits_v1';
    function saveHabitsLocal() {
      try { localStorage.setItem(LS_KEY, JSON.stringify(habits)); }
      catch (e) { console.warn('Local save failed:', e); }
    }
    function loadHabitsLocal() {
      try {
        const raw = localStorage.getItem(LS_KEY);
        habits = raw ? JSON.parse(raw) : [];
        updateConnectionStatus('offline', 'Local Storage Only');
      } catch (e) {
        habits = [];
      }
    }

    // ========= RENDER =========
    function renderHabits() {
      const grid = document.getElementById('habitsGrid');
      grid.innerHTML = '';

      // Empty state
      if (!habits.length) {
        grid.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">üìã</div>
            <p>No habits yet. Add your first one above!</p>
          </div>`;
        document.getElementById('clearBtn').style.display = 'none';
        updateStats();
        return;
      }

      document.getElementById('clearBtn').style.display = 'block';

      const dayNames = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
      habits.forEach(habit => {
        const streak = calculateStreak(habit);

        const card = document.createElement('div');
        card.className = 'habit-item';

        const header = document.createElement('div');
        header.className = 'habit-header';

        const title = document.createElement('div');
        title.className = 'habit-name';
        title.innerHTML = `üåü <span>${escapeHtml(habit.name)}</span> <span class="streak-badge">${streak} day${streak===1?'':'s'} üî•</span>`;

        const del = document.createElement('button');
        del.className = 'delete-habit-btn' + (currentMode==='parent'?' parent-mode':'');
        del.textContent = 'Delete';
        del.onclick = () => deleteHabit(habit.id);

        header.appendChild(title);
        header.appendChild(del);

        const days = document.createElement('div');
        days.className = 'days-grid';

        currentWeekDates.forEach(d => {
          const key = getDateKey(d);
          const box = document.createElement('div');
          box.className = 'day-box' + (habit.completions && habit.completions[key] ? ' completed':'') + (currentMode==='parent' ? ' parent-mode':'');
          box.onclick = () => toggleDay(habit.id, key);

          const name = document.createElement('div');
          name.className = 'day-name';
          name.textContent = dayNames[d.getDay()];

          const date = document.createElement('div');
          date.className = 'day-date';
          date.textContent = `${d.getMonth()+1}/${d.getDate()}`;

          box.appendChild(name);
          box.appendChild(date);
          days.appendChild(box);
        });

        // progress
        const doneThisWeek = currentWeekDates.reduce((acc,d)=> acc + (habit.completions && habit.completions[getDateKey(d)] ? 1:0), 0);
        const pct = Math.round((doneThisWeek / 7) * 100);

        const progress = document.createElement('div');
        progress.className = 'habit-progress';
        progress.innerHTML = `
          <div class="progress-info">
            <span>${doneThisWeek}/7 this week</span>
            <span>${pct}%</span>
          </div>
          <div class="progress-bar">
            <div class="progress-fill" style="width:${pct}%"></div>
          </div>
        `;

        card.appendChild(header);
        card.appendChild(days);
        card.appendChild(progress);
        grid.appendChild(card);
      });

      updateStats();
    }

    function updateStats() {
      document.getElementById('totalHabits').textContent = habits.length;
      document.getElementById('weeklyCompletions').textContent = getWeeklyCompletions();
      document.getElementById('overallRate').textContent = getOverallRate();
    }

    // tiny sanitize for habit titles
    function escapeHtml(str) {
      return String(str)
        .replaceAll('&','&amp;')
        .replaceAll('<','&lt;')
        .replaceAll('>','&gt;')
        .replaceAll('"','&quot;')
        .replaceAll("'","&#039;");
    }
  </script>
</body>
</html>
